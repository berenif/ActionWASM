<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demo Monitor</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #0f0;
        }
        #log {
            background: #000;
            padding: 10px;
            border: 1px solid #0f0;
            height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .error { color: #f00; }
        .warning { color: #ff0; }
        .info { color: #0ff; }
        button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover {
            background: #0a0;
        }
    </style>
</head>
<body>
    <h1>Demo Monitor & Debugger</h1>
    <div>
        <button onclick="loadDemo()">Load Demo in IFrame</button>
        <button onclick="checkPerformance()">Check Performance</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>
    <div id="status">Status: Ready</div>
    <div id="log"></div>
    <iframe id="demoFrame" src="" width="100%" height="600" style="border: 1px solid #0f0; margin-top: 20px; display: none;"></iframe>
    
    <script>
        const log = document.getElementById('log');
        const status = document.getElementById('status');
        let startTime = null;
        let checkInterval = null;
        
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = type;
            entry.textContent = `[${timestamp}] ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }
        
        function clearLog() {
            log.innerHTML = '';
            addLog('Log cleared', 'info');
        }
        
        function loadDemo() {
            const iframe = document.getElementById('demoFrame');
            iframe.style.display = 'block';
            iframe.src = 'demo.html';
            startTime = Date.now();
            status.textContent = 'Status: Loading demo...';
            addLog('Loading demo.html in iframe...', 'info');
            
            // Set up monitoring
            iframe.onload = function() {
                const loadTime = ((Date.now() - startTime) / 1000).toFixed(2);
                addLog(`Demo loaded in ${loadTime} seconds`, 'info');
                status.textContent = 'Status: Demo loaded';
                
                // Start monitoring the iframe
                startMonitoring(iframe);
            };
            
            iframe.onerror = function(e) {
                addLog(`IFrame error: ${e}`, 'error');
                status.textContent = 'Status: Error loading demo';
            };
        }
        
        function startMonitoring(iframe) {
            let lastCheck = Date.now();
            let checkCount = 0;
            
            // Clear any existing interval
            if (checkInterval) {
                clearInterval(checkInterval);
            }
            
            checkInterval = setInterval(() => {
                checkCount++;
                const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
                
                try {
                    // Try to access iframe content
                    const iframeWindow = iframe.contentWindow;
                    const iframeDoc = iframe.contentDocument || iframeWindow.document;
                    
                    // Check if the demo is still running
                    if (iframeWindow && iframeWindow.fpsCounter !== undefined) {
                        const fps = iframeWindow.fpsCounter;
                        const latency = iframeWindow.latencyCounter;
                        const memory = iframeWindow.memoryCounter;
                        const entities = iframeWindow.entitiesCounter;
                        
                        if (checkCount % 5 === 0) { // Log every 5 seconds
                            addLog(`Demo running - Time: ${elapsed}s, FPS: ${fps}, Latency: ${latency}ms, Memory: ${memory}MB, Entities: ${entities}`, 'info');
                        }
                        
                        status.textContent = `Status: Demo running (${elapsed}s) - FPS: ${fps}`;
                    } else {
                        addLog(`Cannot access demo variables at ${elapsed}s`, 'warning');
                    }
                    
                    // Check for any errors in the console
                    if (iframeWindow.console && iframeWindow.console.error) {
                        // This won't actually capture errors, but we can check if the console exists
                    }
                    
                } catch (e) {
                    addLog(`Error accessing iframe at ${elapsed}s: ${e.message}`, 'error');
                    status.textContent = `Status: Error at ${elapsed}s`;
                    
                    // Stop monitoring if we get repeated errors
                    if (checkCount > 10) {
                        clearInterval(checkInterval);
                        addLog('Stopping monitor due to repeated errors', 'error');
                    }
                }
                
            }, 1000); // Check every second
            
            addLog('Started monitoring demo performance', 'info');
        }
        
        function checkPerformance() {
            addLog('Checking browser performance...', 'info');
            
            // Check if requestAnimationFrame is working
            let rafCount = 0;
            const rafStart = performance.now();
            
            function rafTest() {
                rafCount++;
                if (performance.now() - rafStart < 1000) {
                    requestAnimationFrame(rafTest);
                } else {
                    addLog(`requestAnimationFrame: ${rafCount} frames in 1 second`, 'info');
                }
            }
            rafTest();
            
            // Check memory if available
            if (performance.memory) {
                const used = (performance.memory.usedJSHeapSize / 1048576).toFixed(2);
                const total = (performance.memory.totalJSHeapSize / 1048576).toFixed(2);
                const limit = (performance.memory.jsHeapSizeLimit / 1048576).toFixed(2);
                addLog(`Memory: ${used}MB used / ${total}MB total / ${limit}MB limit`, 'info');
            } else {
                addLog('Memory API not available', 'warning');
            }
            
            // Check for any performance issues
            if (window.performance && window.performance.getEntriesByType) {
                const resources = window.performance.getEntriesByType('resource');
                const slowResources = resources.filter(r => r.duration > 1000);
                if (slowResources.length > 0) {
                    addLog(`Found ${slowResources.length} slow resources (>1s load time)`, 'warning');
                    slowResources.forEach(r => {
                        addLog(`  - ${r.name}: ${r.duration.toFixed(0)}ms`, 'warning');
                    });
                }
            }
        }
        
        // Initial log entry
        addLog('Demo monitor ready. Click "Load Demo" to start.', 'info');
        
        // Monitor for any global errors
        window.addEventListener('error', (e) => {
            addLog(`Global error: ${e.message} at ${e.filename}:${e.lineno}:${e.colno}`, 'error');
        });
    </script>
</body>
</html>